{% extends "layout.html" %}


{% block body %}
<div class="container py-5">
   <!-- Header -->
   <div class="row mb-4">
       <div class="col-12 text-center">
       <h1 class="fw-bold mb-2">
           ğŸ§ AudioLab â€¢ TranscriÃ§Ã£o & TraduÃ§Ã£o
       </h1>
       <p class="text-muted mb-0">
           FaÃ§a upload ou grave seu Ã¡udio, veja a transcriÃ§Ã£o em tempo real e traduza para outros idiomas.
       </p>
       </div>
   </div>


   <div class="row g-4">
       <!-- Coluna esquerda: Upload + GravaÃ§Ã£o -->
       <div class="col-lg-5">
       <!-- Card de Upload -->
       <div class="card shadow-sm mb-4">
           <div class="card-body">
           <h5 class="card-title mb-3">
               ğŸ“‚ Enviar arquivo de Ã¡udio
           </h5>
           <p class="text-muted small mb-3">
               Formatos suportados: .ogg, .wav, .mp3, .m4a, .webm (mÃ¡x. 25MB).
           </p>


           <form id="uploadForm" enctype="multipart/form-data">
               <div class="mb-3">
               <label for="audioFile" class="form-label">Selecione o arquivo:</label>
               <input class="form-control" type="file" id="audioFile" name="audio" accept="audio/*">
               </div>
               <button type="submit" class="btn btn-primary w-100">
               ğŸ“ Transcrever arquivo
               </button>
           </form>
           </div>
       </div>


       <!-- Card de GravaÃ§Ã£o -->
       <div class="card shadow-sm">
           <div class="card-body">
           <h5 class="card-title mb-3">
               ğŸ™ï¸ Gravar Ã¡udio agora
           </h5>
           <p class="text-muted small mb-3">
               Use o microfone do seu dispositivo para gravar e transcrever na hora.
           </p>


           <div class="d-flex gap-2 mb-3">
               <button id="recordBtn" class="btn btn-danger flex-grow-1">
               ğŸ¤ Iniciar gravaÃ§Ã£o
               </button>
               <button id="stopBtn" class="btn btn-outline-secondary flex-grow-1" disabled>
               â¹ï¸ Parar
               </button>
           </div>


           <audio id="player" controls class="w-100 d-none mt-2"></audio>


           <small class="text-muted d-block mt-2">
               Dica: permita o acesso ao microfone quando o navegador pedir.
           </small>
           </div>
       </div>
       </div>


       <!-- Coluna direita: TranscriÃ§Ã£o + TraduÃ§Ã£o -->
       <div class="col-lg-7">
       <!-- Card de TranscriÃ§Ã£o -->
       <div class="card shadow-sm mb-4">
           <div class="card-body">
           <div class="d-flex justify-content-between align-items-center mb-2">
               <h5 class="card-title mb-0">
               ğŸ“ TranscriÃ§Ã£o
               </h5>
               <button id="copyTranscriptionBtn" class="btn btn-outline-secondary btn-sm" type="button">
               Copiar texto
               </button>
           </div>


           <div id="transcriptionResult" class="transcription-card" style="display:none;">
               <div id="transcriptionLoading" class="d-flex align-items-center mb-2" style="display:none;">
               <div class="spinner-border text-primary spinner-border-sm me-2" role="status">
                   <span class="visually-hidden">Carregando...</span>
               </div>
               <div id="transcriptionLoading" class="spinner-border" style="display:none;">
                   <span class="fw-semibold">Transcrevendo seu Ã¡udioâ€¦</span>
               </div>
               </div>


               <p id="transcriptionText" class="mb-0" style="white-space: pre-wrap;"></p>
           </div>


           <p id="noTranscriptionHint" class="text-muted small mb-0">
               Nenhuma transcriÃ§Ã£o disponÃ­vel ainda. Envie um arquivo ou grave um Ã¡udio para comeÃ§ar.
           </p>
           </div>
       </div>


       <!-- Card de TraduÃ§Ã£o -->
       <div class="card shadow-sm">
           <div class="card-body">
           <div class="d-flex justify-content-between align-items-center mb-3">
               <h5 class="card-title mb-0">
               ğŸŒ TraduÃ§Ã£o da transcriÃ§Ã£o
               </h5>
           </div>


           <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
               <label for="targetLang" class="form-label mb-0 me-2">Idioma de destino:</label>
               <select id="targetLang" class="form-select form-select-sm" style="width:auto; min-width: 180px;">
               <option value="en">ğŸ‡ºğŸ‡¸ InglÃªs</option>
               <option value="es">ğŸ‡ªğŸ‡¸ Espanhol</option>
               <option value="fr">ğŸ‡«ğŸ‡· FrancÃªs</option>
               <option value="pt-BR">ğŸ‡§ğŸ‡· PortuguÃªs (Brasil)</option>
               <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
               <option value="de">ğŸ‡©ğŸ‡ª AlemÃ£o</option>
               <option value="ja">ğŸ‡¯ğŸ‡µ JaponÃªs</option>
               <option value="zh">ğŸ‡¨ğŸ‡³ Mandarim</option>
               <option value="ko">ğŸ‡°ğŸ‡· Coreano</option>
               </select>


               <button id="translateBtn" class="btn btn-success btn-sm">
               ğŸŒ Traduzir transcriÃ§Ã£o
               </button>


               <button id="copyTranslationBtn" class="btn btn-outline-secondary btn-sm ms-auto" type="button">
               Copiar traduÃ§Ã£o
               </button>
           </div>


           <div id="translationResult" class="translation-card" style="display:none;">
               <div id="translationLoading" class="d-flex align-items-center mb-2" style="display:none;">
               <div class="spinner-border text-success spinner-border-sm me-2" role="status">
                   <span class="visually-hidden">Carregando...</span>
               </div>
               <span class="fw-semibold">Traduzindo textoâ€¦</span>
               </div>


               <p id="translationText" class="mb-0" style="white-space: pre-wrap;"></p>
           </div>


           <p id="noTranslationHint" class="text-muted small mb-0">
               A traduÃ§Ã£o aparecerÃ¡ aqui depois que vocÃª transcrever um Ã¡udio e clicar em <strong>â€œTraduzir transcriÃ§Ã£oâ€</strong>.
           </p>
           </div>
       </div>
       </div>
   </div>
</div>


<style>
   .transcription-card,
   .translation-card {
       background: #f8fbff;
       border-radius: .75rem;
       border: 1px solid rgba(13,110,253,.15);
       padding: 1rem 1.2rem;
   }


   .recording {
       animation: pulse 1.2s infinite;
       background-color: #dc3545 !important;
       border-color: #b02a37 !important;
   }


   @keyframes pulse {
       0%   { transform: scale(1); }
       50%  { transform: scale(1.06); }
       100% { transform: scale(1); }
   }


   .spinner-active .spinner-border {
       animation-play-state: paused;
   }


</style>


<script>
   let mediaRecorder;
   let audioChunks = [];
   let lastTranscript = ""; // guarda Ãºltimo texto transcrito (upload ou gravaÃ§Ã£o)


   const recordBtn = document.getElementById("recordBtn");
   const stopBtn = document.getElementById("stopBtn");
   const player = document.getElementById("player");


   const uploadForm = document.getElementById("uploadForm");


   const transcriptionDiv = document.getElementById("transcriptionResult");
   const transcriptionText = document.getElementById("transcriptionText");
   const transcriptionLoading = document.getElementById("transcriptionLoading");
   const noTranscriptionHint = document.getElementById("noTranscriptionHint");


   const translateBtn = document.getElementById("translateBtn");
   const translationDiv = document.getElementById("translationResult");
   const translationText = document.getElementById("translationText");
   const translationLoading = document.getElementById("translationLoading");
   const noTranslationHint = document.getElementById("noTranslationHint");


   const copyTranscriptionBtn = document.getElementById("copyTranscriptionBtn");
   const copyTranslationBtn = document.getElementById("copyTranslationBtn");


   // --- FunÃ§Ãµes auxiliares ---
   function showTranscription(text) {
       lastTranscript = text || "";
       transcriptionText.textContent = lastTranscript || "(sem texto encontrado)";
       transcriptionDiv.style.display = "block";
       noTranscriptionHint.style.display = "none";
   }


   function startTranscriptionLoading() {
       transcriptionDiv.style.display = "block";
       transcriptionLoading.style.display = "flex";
       transcriptionText.textContent = "";
       noTranscriptionHint.style.display = "none";
   }    


   function stopTranscriptionLoading() {
       transcriptionLoading.style.display = "none";


       // Remover qualquer classe de animaÃ§Ã£o residual
       transcriptionLoading.classList.remove("spinner-active");
   }


   function startTranslationLoading() {
       translationDiv.style.display = "block";
       translationLoading.style.display = "flex";
       translationText.textContent = "";
       noTranslationHint.style.display = "none";
   }


   function stopTranslationLoading() {
       translationLoading.style.display = "none";
       translationLoading.classList.remove("spinner-active");
   }


   // --- UPLOAD MANUAL (botÃ£o Transcrever) ---
   uploadForm.addEventListener("submit", async (event) => {
       event.preventDefault();


       const fileInput = document.getElementById("audioFile");
       if (!fileInput.files.length) {
       alert("Selecione um arquivo de Ã¡udio primeiro!");
       return;
       }


       const formData = new FormData();
       formData.append("audio", fileInput.files[0]);


       startTranscriptionLoading();


       try {
       const response = await fetch("/upload-audio", {
           method: "POST",
           body: formData
       });


       const result = await response.json();


       if (result.error) {
           stopTranscriptionLoading();
           transcriptionText.textContent = "âŒ Erro: " + result.error;
           return;
       }


       stopTranscriptionLoading();
       showTranscription(result.text_original || result.texto || result.transcription || "");
       } catch (err) {
       stopTranscriptionLoading();
       transcriptionText.textContent = "âŒ Erro inesperado ao processar o Ã¡udio.";
       }
   });


   // --- GRAVAÃ‡ÃƒO VIA MICROFONE ---
   recordBtn.addEventListener("click", async () => {
       try {
       const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
       mediaRecorder = new MediaRecorder(stream);
       audioChunks = [];


       mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);


       mediaRecorder.onstop = async () => {
           const blob = new Blob(audioChunks, { type: "audio/webm" });
           const file = new File([blob], "gravacao.webm", { type: "audio/webm" });


           // mostra player
           player.src = URL.createObjectURL(blob);
           player.classList.remove("d-none");


           const formData = new FormData();
           formData.append("audio", file);


           startTranscriptionLoading();


           try {
           const response = await fetch("/upload-audio", {
               method: "POST",
               body: formData
           });


           const result = await response.json();


           if (result.error) {
               stopTranscriptionLoading();
               transcriptionText.textContent = "âŒ Erro: " + result.error;
               return;
           }


           stopTranscriptionLoading();
           showTranscription(result.text_original || result.texto || result.transcription || "");
           } catch (err) {
           stopTranscriptionLoading();
           transcriptionText.textContent = "âŒ Erro inesperado ao processar o Ã¡udio.";
           }
       };


       mediaRecorder.start();
       recordBtn.disabled = true;
       recordBtn.classList.add("recording");
       recordBtn.textContent = "ğŸ”´ Gravando...";
       stopBtn.disabled = false;


       } catch (err) {
       alert("NÃ£o foi possÃ­vel acessar o microfone. Verifique as permissÃµes do navegador.");
       }
   });


   stopBtn.addEventListener("click", () => {
       if (mediaRecorder && mediaRecorder.state !== "inactive") {
       mediaRecorder.stop();
       }
       recordBtn.disabled = false;
       recordBtn.classList.remove("recording");
       recordBtn.textContent = "ğŸ¤ Iniciar gravaÃ§Ã£o";
       stopBtn.disabled = true;
   });


   // --- TRADUÃ‡ÃƒO (usa /traduzir com texto, nÃ£o Ã¡udio) ---
   translateBtn.addEventListener("click", async () => {
       if (!lastTranscript || !lastTranscript.trim()) {
       alert("Primeiro faÃ§a uma transcriÃ§Ã£o (upload ou gravaÃ§Ã£o) antes de traduzir.");
       return;
       }


       const lang = document.getElementById("targetLang").value;


       startTranslationLoading();


       try {
       const response = await fetch("/traduzir", {
           method: "POST",
           headers: {
           "Content-Type": "application/json"
           },
           body: JSON.stringify({
           text: lastTranscript,
           target_lang: lang
           })
       });


       const result = await response.json();


       stopTranslationLoading();


       if (result.error) {
           translationText.textContent = "âŒ Erro: " + result.error;
           return;
       }


       translationText.textContent = result.translated_text || "(sem traduÃ§Ã£o)";
       noTranslationHint.style.display = "none";
       translationDiv.style.display = "block";


       } catch (err) {
       stopTranslationLoading();
       translationText.textContent = "âŒ Erro inesperado ao traduzir o texto.";
       }
   });


   // --- Copiar textos ---
   copyTranscriptionBtn.addEventListener("click", async () => {
       if (!lastTranscript) {
       alert("NÃ£o hÃ¡ transcriÃ§Ã£o para copiar ainda.");
       return;
       }
       try {
       await navigator.clipboard.writeText(lastTranscript);
       copyTranscriptionBtn.textContent = "Copiado!";
       setTimeout(() => copyTranscriptionBtn.textContent = "Copiar texto", 1500);
       } catch {
       alert("NÃ£o foi possÃ­vel copiar para a Ã¡rea de transferÃªncia.");
       }
   });


   copyTranslationBtn.addEventListener("click", async () => {
       const text = translationText.textContent.trim();
       if (!text) {
       alert("NÃ£o hÃ¡ traduÃ§Ã£o para copiar ainda.");
       return;
       }
       try {
       await navigator.clipboard.writeText(text);
       copyTranslationBtn.textContent = "Copiado!";
       setTimeout(() => copyTranslationBtn.textContent = "Copiar traduÃ§Ã£o", 1500);
       } catch {
       alert("NÃ£o foi possÃ­vel copiar para a Ã¡rea de transferÃªncia.");
       }
   });
</script>
{% endblock %}


